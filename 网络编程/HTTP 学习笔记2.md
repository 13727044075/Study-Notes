
阅读《图解HTTP》的学习笔记。

这部分主要是讲述有关 HTTP 安全的问题，以及和 服务器相关的内容。

---
## 3. HTTP 安全

### HTTPS

前面提到 HTTP 是一个采用明文、不进行加密处理、不进行认证，也无法确保报文完整性的协议，这种做法是非常不安全的，因此也就有了安全性更高的 HTTPS（HTTP Secure）的出现。

HTTPS 不是应用层的一种新协议，它只是 HTTP 通信接口部分用 SSL(Secure Socket Layer)和 TLS（Transfer Layer Security）协议代替而已。它具备加密处理报文、认证和完整性保护的机制。在使用 HTTPS 通信的时候，不再采用 http://，而是改用 https://。

SSL 是当今世界上应用最为广泛的网络安全技术，它是独立于 HTTP 的协议。

#### 公开密钥加密技术

SSL 采用的是一种叫做公开密钥技术的加密处理方式。

近代的加密方法中，加密算法是公开的，而密钥是保密的，通过这种方法来保持加密方法的安全性。

##### **共享密钥加密**

共享密钥加密，也叫做对称密钥加密，是加密和解密都采用同一个密钥的方式。这种加密方法的难点是如何安全发送密钥给对方。

正是有这种缺陷，所以有了公开密钥方法。

##### **公开密钥加密**

公开密钥加密采用一对非对称的密钥，一个公开密钥和一个私有密钥，前者是公开的，用于加密，而后者是保密的，用于解密。

这种加密方式，发送密文的一方采用对方的公开密钥进行加密处理，对方收到被加密的信息后，再使用自己的私有密钥进行解密。采用这种方式，不需要发送用来解密的私有密钥，也不必担心密钥被攻击者窃听而盗走。

当然，这种方式还是有所缺陷，就是无法证明公开密钥本身就是货真价实的公开密钥。比如正准备和某台服务器建立公开密钥加密方式下的通信时，如何证明收到的公开密钥就是原本预想的那台服务器发行的公开密钥。或许在公开密钥传输途中，真正的公开密钥已经被攻击者替换掉了。

为了解决这个问题，可以使用由数字证书机构（CA, Certificate Authority）和其相关机关办法的公开密钥证书。

##### **HTTPS 采用混合加密机制**

HTTPS 采用共享密钥加密和公开密钥加密两者并用的混合加密机制。若密钥能够实现安全交换，就有可能考虑仅使用公开加密来通信。但公开密钥加密相比共享密钥加密，处理速度要更慢。

所以应该要充分利用两者各自的优势，将多种方法组合起来用于通信。在交换密钥环境使用公开密钥加密方式，之后的建立通信交换报文阶段则使用共享密钥加密方式。这是因为公开密钥加密方式处理起来更加复杂，若在通信时采用这种加密，效率会很低。

另外，对于采用 SSL 也会导致整体处理速度和通信速度的变慢：
- 通信慢，采用 SSL，会比采用 HTTP，网络负载可能变慢 2 到 100 倍，因为需要进行 SSL 通信，整体上处理通信量不可避免会增加。
- SSL 必须进行加密处理，这会大量消耗 CPU和内存等资源，导致处理速度变慢。

#### EV SSL 证书（Extended Validation SSL Certificate）

证书的一个作用是证明作为通信一方的服务器是否规范，另外一个作用是确认对方服务器背后运营的企业是否真实存在。拥有该特性的证书就是 EV SSL 证书。

持有EV SSL 证书的 Web 网站的浏览器地址栏处的背景色是绿色的，而且地址栏左侧显示了 SSL 证书中记录的组织名称以及颁发证书的认证机构名称。

上述意图是防止用户被钓鱼攻击（Phishing），但很多用户并不了解 EV SSL 证书相关的知识，不会太留意它

#### 客户端证书

HTTPS 中还可以使用客户端证书。用客户端证书进行客户端认证，其作用和服务器证书一样。

但客户端证书存在几个问题：

- 客户端证书的获取需要用户自行安装，但客户端证书需要付费购买，因此现状是只有安全性极高的认证机构可颁发客户端证书，但仅用于特殊用途的业务，比如网上银行；
- 证书无法证明用户本人的真实有效性

另外，现在采用 OpenSSL 开源程序可以构建自己的认证机构，这种认证机构叫做自认证机构，颁发的证书叫做自签名证书。浏览器访问使用这种证书的服务器时，会显示“无法确认连接安全性”或者“该网站的安全证书存在问题”等警告信息。

多数浏览器内预先已植入备受信赖的认证机构的整数，但也有一小部分浏览器会植入中级认证机构的证书。

中级认证机构的证书可能会变成自认证证书

### 认证方式

计算器本身是无法判断坐在显示器前的使用者的身份，更不用说网络对面的用户身份，为了能验证对方的身份，是否具备访问的权限，需要核对“登录人本人才知道或者才会有的信息”，即包括：

- 密码：只有本人才会知道的字符串信息
- 动态令牌：仅限本人持有的设备内显示的一次性密码
- 数字证书：仅限本人（终端）持有的信息
- 生物认证：指纹和虹膜的等本人的生理信息
- IC 卡等：仅限本人持有的信息

对于 HTTP，在 1.1 版本中采用下述认证方式：

- BASIC 认证（基本认证）
- DIGEST 认证（摘要认证）
- SSL 客户端认证
- FormBase 认证（基于表单认证）

#### BASIC 认证

BASIC 认证是 HTTP/1.0 版本开始就定义的认证方式，现在有一部分网站采用这种认证方式。

认证步骤如下：

1. 客户端发送请求，如下所示

```
GET /private/ HTTP/1.1
Host: hackr.jp
```
2. 服务器返回状态码 401 以告知客户端需要进行认证
3. 客户端将用户 ID 和密码以 Base64 方式编码后发送
4. 认证成功，服务器返回状态码 200，否则继续发送状态码 401

BASIC 认证虽然采用 Base64 编码方式，但并不是加密处理，不需要任何附加信息即可解码，会有被窃听的风险。

另外，想再进行一次 BASIC 认证时，一般的浏览器却无法实现认证注销操作。

使用不够便捷灵活，且达不到多数 Web 网站期望的安全性登记，因此该认证方法并不常用。

#### DIGEST 认证

为了弥补 BASIC 认证的缺点，在 HTTP/1.1 起就有了 DIGEST 认证。 它采用质询/响应的方式，但不会像 BASIC 认证那样直接发送明文密码。

所谓质询响应是指，一开始一方会先发送认证要求给另一方，接着使用从另一方接收到的质询码计算响应码，最后将响应码返回给对方进行认证的方式。因此，发送的只是响应摘要和由质询码产生的计算结果，相比 BASIC 认证，密码泄露的可能性就降低了。

尽管安全性高于 BASIC 认证，但是和 HTTPS 的客户端认证相比还是很弱，它虽然提供了防止密码被窃听的保护机制，但不存在防止用户伪装的保护机制

使用同样不够便捷灵活，安全性也不够高，适用范围也有所受限。

#### SSL 客户端认证

SSL 客户端认证是借由 HTTPS 的客户端证书完成认证的方式。

不仅仅依靠证书完成认证，还会和基于表单认证形成一种双因素认证

#### FormBase 认证

该认证方式不是在 HTTP 协议中定义的
目前的认证大多数是用 Web 应用程序各自实现的基于表单的认证方式
一般采用 Cookie 来管理 Session（会话）

### Web 攻击技术

简单的 HTTP 协议本身不存在安全性问题，真正作为攻击目标的是应用 HTTP 协议的服务器和客户端，以及运行在服务器上的 Web 应用等，并且目前来自互联网的攻击大多是冲着 Web 站点来的。当前 Web 应用容易遭受攻击，也是有以下两点原因：

1.  **HTTP 不具备必要的安全功能** 
HTTP 只是一个通用的单纯协议机制，在具备简单灵活通用的优势的同时在安全性方面是呈弱势的，它的缺点也主要就是在安全性方面，没有加密处理报文、没有认证方法和无法保证报文的完整性。
2.  **在客户端即可篡改请求** 在 Web 应用中，从浏览器那接收到的 HTTP 请求的全部内容，都可以在客户端自由地变更、篡改，这会导致 Web 应用接收到和预期数据不相同的内容。此外，只需要在 HTTP 请求报文加载攻击代码，比如通过 URL 查询字段或表单、HTTP 首部、Cookie 等途径将攻击代码传入，就能发起对 Web 应用的攻击，如果 Web 应用存在安全漏洞，那内部信息就会遭到窃取，或者被攻击者获取管理权限。

#### 针对 Web 应用的攻击模式

对 Web 应用的攻击模式主要有以下两种：

- 主动攻击：指攻击者通过直接访问 web 应用，把攻击代码传入的攻击模式。代表性的攻击有 SQL 注入攻击和 OS 命令注入攻击。
- 被动攻击：指利用圈套策略执行攻击代码的攻击模式。在被动攻击过程中，攻击者不直接对目标 Web 应用访问发起攻击，而是引诱用户踏入设定好的陷阱，比如点击链接等方式，用户触发陷阱后就会把含有攻击代码的 HTTP 请求发送到攻击目标的 Web 应用。代表性的攻击有跨站脚本攻击（XSS）、HTTP 首部注入攻击和会话固定攻击等。

不同的攻击方式都是针对 Web 应用内部的不同安全漏洞而实现的，因此也可以根据针对的安全漏洞进行分类。

##### 输出值转义不完全而造成的安全漏洞

Web 应用的安全对策大致可以分为以下两个部分：

1. 客户端的验证
2. Web 应用端（服务器端）的验证--包括输入值验证和输出值转义。

多数情况采用 JavaScript 在客户端进行验证数据，但是客户端允许篡改数据或关闭 JavaScript，不适合将 JavaScript 验证作为安全的防范对策。因此，保留客户端验证只是为了尽早地辨识输入错误，提高 UI 体验的作用。

Web 应用端的输入值验证按 Web 应用内的处理则有可能被误认为是具有攻击性意义的代码。输入值验证通常是指检测是否是符合系统业务逻辑的数值或检查字符编码等预防对策。

而输出值转义是对于从数据库或文件系统、HTML、邮件等输出 Web 应用处理的数据所做的操作，但是输出值转义不完全时，会触发攻击者传入的攻击代码，给输出对象带来损害。

###### 跨站脚本攻击（Cross-Site Scripting XSS）

XSS 指通过存在安全漏洞的 Web 网站注册用户的浏览器内运行非法的 HTML 标签或 JavaScript 进行的一种攻击。属于被动攻击模式。动态创建的 HTML 部分可能有隐藏着安全漏洞。

XSS 可能造成以下影响：

- 利用虚假输入表单获取用户个人信息
- 利用脚本窃取用户的 Cookie 值，被害者在不知情的情况下，帮助攻击者发送恶意请求
- 显示伪造的文章或图片

###### SQL 注入攻击

SQL 注入攻击（SQL Injection）是指针对 Web 应用使用的数据库，通过运行非法的 SQL 而产生的攻击。该安全隐患有可能引发极大的威胁，有时会直接导致个人信息及机密信息的泄露。

SQL 注入攻击可能会带来以下影响：

- 非法查看或篡改数据库内的数据
- 规避认证
- 执行和数据库服务器业务关联的程序等

SQL 注入是攻击者将 SQL 语句改变成开发者意想不到的形式以达到破坏结构的攻击。

###### OS 命令注入攻击

OS 命令注入攻击（OS Command Injection）是指通过 Web 应用，执行非法的操作系统命令达到攻击的目的。只要在能调用 Shell 函数的地方就有存在被攻击的风险。

OS 命令注入攻击可以向 Shell 发送命令，让 Windows 或 Linux 操作系统的命令行启动程序，也就是，通过 OS 注入攻击可以执行 OS 上安装着的各种程序。

###### HTTP 首部注入攻击

HTTP 首部注入攻击（HTTP Header Injection）是指攻击者通过在响应首部字段内插入换行，添加任意响应首部或主体的一种攻击。属于被动攻击模式。

向首部主题内添加内容的攻击称为 HTTP 响应截断攻击（HTTP Response Splitting Attack）。

如下所示，Web 应用有时会把从外部接收到的值，赋给响应首部字段 Location 和 Set-Cookie。

```
Location: http://www.example.com/a.cgi?q=12345
Set-Cookie: UID=12345

* 12345就是插入值
```
HTTP 首部注入可能像这样，通过在某些响应首部字段需要处理的地方，插入换行符（即 %0D%0A）发动攻击。

HTTP 首部注入攻击可能会造成以下的一些影响：

- 设置任何 Cookie 信息
- 重定向至任意 URL
- 显示任意的主体（HTTP 响应截断攻击--向首部主体内添加内容的攻击）

###### 邮件首部注入攻击

邮件首部注入攻击（Mail Header Injection）是指 Web 应用中的邮件发送功能，攻击者通过邮件首部 To 或 Subject 内任意添加非法内容发起的攻击。

###### 目录遍历攻击

目录遍历（Directory Traversal）攻击是指对本无意公开的文件目录，通过非法截断其目录路径后，达成访问目的的一种攻击。有时也被成为路径遍历（Path Traversal）攻击。

对这种攻击，固然存在输出值转义的问题，但更应该关闭指定对任意文件名的访问权限

###### 远程文件包含漏洞

远程文件包含漏洞（Remote File Inclusion）是指当前部分脚本内容需要从其他文件读入时，攻击者利用指定外部服务器的 URL 充当依赖文件，让脚本读取之后，就可运行任意脚本的一种攻击。

这主要是 PHP 存在的安全漏洞，对 PHP 的 include 或 require 来说，这是一种可通过设定，指定外部服务器的 URL 作为文件名的功能。但是该功能太危险，PHP 5.2.0 之后默认此功能无效。

固然存在输出值转义问题，但更应该控制对任意文件名的指定。

##### 设置或者设计上的缺陷引起的安全漏洞

因设置或设计上的缺陷引发的安全漏洞是指，错误设置 Web 服务器或者是由于设计上的一些问题引起的安全漏洞。

###### 强制浏览

强制浏览是指从安置在 Web 服务器的公开目录下的文件中，浏览那些原本非自愿公开的文件。

强制浏览可能会造成以下一些影响：

- 泄露顾客的个人信息等重要情报
- 泄露原本需要具有访问权限的用户才可以查阅的信息内容
- 泄露未外连到外界的文件

###### 不正确的错误消息处理

不正确的错误信息处理是指 Web 应用的错误信息包含对攻击者有用的信息。和 Web 应用有关的主要错误信息如下所示：

- Web 应用抛出的错误信息
- 数据库等系统抛出的错误信息
    - PHP 或 ASP 等脚本错误
    - 数据库或中间件的错误
    - Web 服务器的错误

###### 开放重定向

开放重定向（Open Redirect）：对指定的任意 URL 作重定向跳转的功能。与此相关的安全漏洞是指，假如重定向 URL 到某个具有恶意的 Web 网站，那么用户就会被诱导至那个 Web 网站。


##### 会话管理疏忽引发的安全漏洞

会话管理是用来管理用户状态的必备功能，但是如果在会话管理上有所疏忽，就会导致用户的认证状态被窃取等后果。

######会话劫持

会话劫持（Session Hijack）指通过某种手段拿到用户的会话 ID，并非法使用此会话 ID 伪装成用户，达到攻击的目的。

下面是几种攻击者可获得会话 ID 的途径：

- 通过非正规的生成方法推测会话 ID
- 通过窃听或 XSS 攻击盗取会话 ID
- 通过会话固定攻击（Session Fixation）强行获取会话 ID

###### 会话固定攻击

会话固定攻击（Session Fixation）会强制用户使用攻击者指定的会话 ID，属于被动攻击。

###### 跨站点请求伪造

跨站点请求伪造（Cross-Site Request Forgeries，CSRF）指攻击者通过设置好的陷阱，强制对已完成认证的用户进行非预期的个人信息或设定信息等某些状态更新，属于被动攻击。

跨站点请求伪造可能会造成以下这些影响：

- 利用已通过认证的用户权限更新设定信息等
- 利用已通过认证的用户权限购买商品
- 利用已通过认证的用户权限在留言板上发表言论

##### 其他安全漏洞

###### 密码破译

密码破解攻击（Password Cracking）即算出密码，突破认证，攻击不局限于 Web 应用，还包括其他的系统（如 FTP 或 SSH 等）

密码破解有下面两种手段：

**通过网络的密码试错**
- 穷举法（Brute-force Attack，又称为暴力破解法）指对所有密钥集合构成的密钥空间（Keyspace）进行穷举
- 字典攻击指利用事先收集好的候选密码（经过各种组合方式后存入字典），枚举字典中的密码，尝试通过认证的一种攻击手法。

**对已加密密码的破解（指攻击者入侵系统，已获得加密或散列处理的密码数据的情况）**
- 通过穷举法或者字典攻击进行类推
- 彩虹表（Rainbow Table）是由明文密码及与之对应的散列值构成的一种数据库表，是一种通过事先制作庞大的彩虹表
- 拿到密钥
- 加密算法的漏洞

###### 点击劫持

点击劫持（Clickjacking）指利用透明的按钮或链接做成陷阱，覆盖在 Web 页面只上，然后诱使用户在不知情的情况下，点击那个链接访问内容的一种攻击手段，又被称为界面伪装（UI Redressing）。

###### DoS攻击

DoS 攻击（Denial of Service attack）是一种让运行中的服务呈停止状态的攻击，有时也叫做服务停止攻击或拒绝服务攻击，攻击对象不仅限于 Web 网站，还包括网络设备和服务器等。

主要有两种攻击方式：
- 集中利用访问请求造成资源过载，资源用尽的同时，实际上服务也就呈停止状态。
- 通过攻击安全漏洞使服务停止

其中，集中利用访问请求的 DoS 攻击，单纯来讲就是发送大量合法请求。服务器很难分辨何为正常请求，何为攻击请求，因此很难防止 DoS 攻击。

DDos 攻击（Distributed Denial of Service attack）是指多台计算机发起的 DoS 攻击。它通常利用那些感染病毒的计算机作为攻击跳板。

###### 后门程序

后门程序（Backdoor）是指开发设置的隐藏入口，可不按正常步骤使用受限功能。

通常的后门程序分为以下 3 种类型：

- 开发阶段作为 Debug 调用的后门程序
- 开发者为了自身利益植入的后门程序
- 攻击者通过某种方法设置的后门程序

---

## 4. Web 应用

### Web 服务器

#### 虚拟主机

HTTP/1.1 规范允许一台 HTTP 服务器搭建多个 Web 站点。比如提供 Web 托管服务的供应商，可以用一台服务器为多位客户服务，也可以以每位客户持有的域名运行各自不同的网站。

这是因为利用了虚拟主机（Virtual Host，又称虚拟服务器）的功能。所以即便物理层面只有一台服务器，但只要使用虚拟主机的功能，则可以假想已经具有多台服务器。

在相同的 IP 地址下，由于虚拟主机可以寄存多个不同主机名和域名的 Web 网站，因此在发送 HTTP 请求时，必须在 Host 首部内完整指定主机名或域名的 URI。

#### 代理

代理是一种由转发功能的应用程序，它扮演了位于服务器和客户端“中间人”的角色，接收由客户端发送的请求并发送给服务器，同时也接收服务器返回的响应并返回给客户端。

代理服务器的基本行为就是接收客户端发送的请求后转发给其他服务器。代理不改变请求 URI，会直接发送给前方持有资源的目标服务器。

持有资源实体的服务器被称为源服务器。从源服务器返回的响应经过代理服务器后再转给客户端。

在 HTTP 通信过程中，可以级联多台代理服务器。转发时，需要附加 Via 首部字段以标记经过的主机信息。

采用代理服务器的理由有：

- 利用缓存技术减少网络带宽的流量
- 组织内部针对特定网站的访问控制，以获取访问日志为主要目的
- 等等

代理有多种使用方式，按两种基准分类，一种是是否使用缓存，一种是是否会修改报文。

- **缓存代理** 缓存代理会将资源的副本（缓存）保存在代理服务器上，然后再转发响应。当接收到同样的资源请求，就可以不需要从源服务器获取资源，而是将缓存的资源作为响应返回即可。
- **透明代理** 转发请求或响应的时候不对报文做任何加工的代理，反之，对报文内容进行加工的被称为非透明代理

#### 网关

网关是转发其他服务器通信数据的服务器。其工作机制和代理十分相似，但网关有以下两个特点：

1. 网关能使通信线路上的服务器提供非 HTTP 协议服务；
2. 网关可以提供通信的安全性，因为可以在客户端和网关之间的通信线路上加密以确保连接的安全。


#### 隧道

隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序。

隧道的目的是确保客户端和服务器进行安全的通信。它本身不会解析 HTTP 请求，而是将请求保持原样中转给服务器，它会在通信双方断开连接时结束。

#### 缓存

缓存是指代理服务器或客户端本地磁盘内保持的资源副本。利用缓存可减少对源服务器的访问，从而节省通信流量和通信时间。

缓存服务器是代理服务器的一种，并归类在缓存代理类型中。**缓存服务器的优势在于利用缓存可避免多次从源服务器转发资源**。因此客户端可以就近从缓存服务器上获取资源，而源服务器也不必多次处理相同的请求。

缓存资源存在一个有效性问题，而且客户端也会在请求中指示所需要资源的更新时间等，这让缓存服务器需要向源服务器确认资源的有效性，若判断缓存资源失效，还需要重新从源服务器获取“新”资源。

缓存不仅可以存在于缓存服务器内，也可以存在客户浏览器中，但也同样存在缓存资源的有效性问题。

### 构建 Web 内容的技术

当前 Web 应用主要就是 Web 网站，而建立一个 Web 网站需要各种不同的技术，包括最基础的 HTML，实现不同样式的 CSS，实现动态效果的 JavaScript 等技术。

#### HTML

HTML（HyperText Markup Language，超文本标记语言）是为了发送 Web 上的超文本（Hypertext）而开发的标记语言。HTML 采用一种叫做 HTML 标签（Tag）的特殊字符串来修饰文档的语言。

平时我们浏览的 Web 页面几乎全是使用 HTML 写成的，由 HTML 构成的文档经过浏览器的解析、渲染后，呈现出来的就是我们看到的 Web 页面。

HTML 目前分为 4.01 版本和 5.0 版本，后者也就是 HTML5，它不仅解决了浏览器之间的兼容问题，并且可以把文本作为数据对待，更容易复用，动画等效果也变得更加生动。

#### CSS

CSS（Cascading Style Sheets，层叠样式表）可以指定如何展现 HTML 内的各种元素，属于样式表标准之一。不同设定的 CSS，用浏览器看到的 Web 页面外观是不相同的。

CSS 的理念就是让文档的结构和设计分离，达到解耦的目的。

#### 动态 HTML 

所谓动态 HTML（Dynamic HTML）就是指使用客户端脚本语言将静态的 HTML 内容变成动态的技术的总称。

它是通过采用脚本语言 JavaScript ，实现对 HTML 的 Web 页面的动态改造；利用 DOM（Document Object Model，文档对象模型）可以将 HTML 内的元素当做对象操作，比如取出元素内的字符串、改变其 CSS 的属性，使页面的设计发生改变。

#### 数据发布的格式及语言

**XML--可拓展标记语言**

XML（eXtensible Markup Language，可拓展标记语言）是一种可按应用目标进行拓展的通用标记语言。其特点如下：

- 采用标签构成树形结构，并且可自定义拓展标签
- 读取 XML 文档的数据比起 HTML 更加简单
- 更容易复用数据

**发布更新信息的 RSS / Atom**

RSS（简易信息聚合，也叫聚合内容）和 Atom 都是发布新闻或博客日志等更新信息文档的格式的总称，都用到了 XML。

**JSON**
JSON（JavaScript Object Notion）是一种以 JavaScript 的对象表示法为基础的轻量级数据标记语言。

主要特点如下：

- 可以处理 false / true / null / 数组/对象/数字/字符串 7种数据类型
- 让数据更轻更纯粹
- 多种编程语言都提供实现 JSON 的类库

